package com.fpd.slamdunk.bussiness.home.fragment;import android.content.Context;import android.content.Intent;import android.os.Bundle;import android.support.v4.app.Fragment;import android.support.v4.widget.SwipeRefreshLayout;import android.support.v7.widget.LinearLayoutManager;import android.util.Log;import android.view.LayoutInflater;import android.view.View;import android.view.ViewGroup;import com.baidu.apistore.sdk.ApiCallBack;import com.baidu.apistore.sdk.ApiStoreSDK;import com.baidu.apistore.sdk.network.Parameters;import com.fpd.basecore.config.URLContans;import com.fpd.model.sportnews.ArticleEntity;import com.fpd.model.sportnews.SportNewsEntity;import com.fpd.model.sportnews.SportNewsEntityData;import com.fpd.slamdunk.R;import com.fpd.slamdunk.bussiness.home.adapter.RecyclerBaseAdapter;import com.fpd.slamdunk.bussiness.sportnews.activity.SportActivity;import com.google.gson.Gson;import com.lhh.ptrrv.library.PullToRefreshRecyclerView;import java.text.SimpleDateFormat;import java.util.ArrayList;import java.util.Date;import java.util.List;/** * Created by solo on 2016/6/5. */public class ShareFragment extends Fragment implements RecyclerBaseAdapter.OnItemClickListener{    private Context mContext;    private View mContentView;    //List相关    private PullToRefreshRecyclerView mSharList;    private RecyclerBaseAdapter mAdapter;    private List<ArticleEntity> mDatas;    private boolean isFirst=true;    private SimpleDateFormat sdf = new SimpleDateFormat("yyyy-MM-dd");    private int upPage;    private int downPage;    private final int FLAG_UP=0;    private final int FLAG_DOWN=1;    @Override    public View onCreateView(LayoutInflater inflater, ViewGroup container, Bundle savedInstanceState)    {        mContentView = inflater.inflate(R.layout.fragment_share, container, false);        mContext=getActivity();        initViews();        initList();        initEvents();        return mContentView;    }    @Override    public void setUserVisibleHint(boolean isVisibleToUser)    {        super.setUserVisibleHint(isVisibleToUser);        if(isVisibleToUser)        {            if(mSharList!=null && isFirst)            {                mDatas.clear();                getShareList(5, FLAG_DOWN);                upPage=5;                downPage=5;            }        }        else        {        }    }    private void initViews()    {        mSharList=(PullToRefreshRecyclerView)mContentView.findViewById(R.id.id_share_list);    }    private void initEvents()    {        mAdapter.setOnItemClickListener(this);    }    private void initList()    {        mSharList.setLayoutManager(new LinearLayoutManager(mContext));        mSharList.setSwipeEnable(true);        mSharList.setPagingableListener(new PullToRefreshRecyclerView.PagingableListener()        {            @Override            public void onLoadMoreItems()            {                getShareList(++downPage,FLAG_DOWN);            }        });        mSharList.setOnRefreshListener(new SwipeRefreshLayout.OnRefreshListener()        {            @Override            public void onRefresh()            {                getShareList(--upPage,FLAG_UP);            }        });        mDatas=new ArrayList<>();        mAdapter=new RecyclerBaseAdapter<ArticleEntity>(mContext,mDatas,R.layout.sportnews_list_item)        {            @Override            public void convert(RecyclerBaseAdapter.RecyclerHolder holder, ArticleEntity item, int position, boolean isScrolling)            {                if(item.isReaded)                {                    Date date=new Date(item.time*1000);                    String timeString=sdf.format(date);                    holder.setTextColor(R.id.id_sportnews_title,item.title,                            getResources().getColor(R.color.gray01));                    holder.setImgByUrl(R.id.id_sportnews_img, item.img);                    holder.setTextColor(R.id.id_sportnews_author, item.author,                            getResources().getColor(R.color.gray01));                    holder.setTextColor(R.id.id_sportnews_time,timeString,                            getResources().getColor(R.color.gray01));                }else                {                    Date date=new Date(item.time*1000);                    String timeString=sdf.format(date);                    holder.setTextColor(R.id.id_sportnews_title,item.title,                            getResources().getColor(R.color.colorblack));                    holder.setImgByUrl(R.id.id_sportnews_img, item.img);                    holder.setTextColor(R.id.id_sportnews_author, item.author,                            getResources().getColor(R.color.gray01));                    holder.setTextColor(R.id.id_sportnews_time,timeString,                            getResources().getColor(R.color.gray01));                }            }        };        mSharList.setAdapter(mAdapter);    }    private void getShareList(final int page, final int flag) {        Parameters para = new Parameters();        para.put("id", "nba");        para.put("page", page+"");        ApiStoreSDK.execute("http://apis.baidu.com/3023/news/channel",                ApiStoreSDK.GET, para,                new ApiCallBack()                {                    @Override                    public void onSuccess(int status, String responseString)                    {                        isFirst=false;                        SportNewsEntity sne=null;                        try                        {                            sne = new Gson().fromJson(responseString, SportNewsEntity.class);                        }catch (Exception e)                        {                        }                        if (sne != null)                        {                            SportNewsEntityData data = sne.data;                            if (data != null)                            {                                List<ArticleEntity> article_list = data.article;                                ArrayList temp=new ArrayList();                                for (ArticleEntity article : article_list)                                {                                    temp.add(article);                                }                                if(flag==FLAG_UP)                                {                                    mDatas.addAll(0, temp);                                }else if(flag==FLAG_DOWN)                                {                                    mDatas.addAll(temp);                                }                            }                        }                        mAdapter.notifyDataSetChanged();                        if(flag==FLAG_DOWN && downPage==10)                        {                            mSharList.onFinishLoading(false, false);                        }                        else if(flag==FLAG_UP && upPage==1)                        {                            mSharList.setOnRefreshComplete();                            mSharList.setSwipeEnable(false);                        }                        else                        {                            if(flag==FLAG_DOWN)                            {                                mSharList.onFinishLoading(true, false);                            }else if(flag==FLAG_UP)                            {                                mSharList.setOnRefreshComplete();                            }                        }                    }                    @Override                    public void onComplete() {}                    @Override                    public void onError(int status, String responseString, Exception e)                    {                        Log.i("TAG", "onError, status: " + status);                        Log.i("TAG", "errMsg: " + (e == null ? "" : e.getMessage()));                    }                });    }    @Override    public void onItemClick(int position)    {        mDatas.get(position).isReaded=true;        mAdapter.notifyDataSetChanged();        Intent intent=new Intent(mContext, SportActivity.class);        intent.putExtra(URLContans.SPORT_NEWS_URL,mDatas.get(position).url);        startActivity(intent);    }}